# 复合井字棋（Ultimate Tic-Tac-Toe）

本项目演示一个基于 Vue + Vite 的嵌套井字棋（Ultimate Tic-Tac-Toe）在线对战示例，包含一个非常简单的 WebSocket 后端（演示用途），支持：

- 两位玩家在线对战（房间制）
- 观战者加入房间并实时观看
- 嵌套井字棋规则：每步指定小九宫格；小格被占领则填充为占领方；大格若三个小格连线则胜利

---

## 目录结构

- `src/` 前端 Vue 代码
- `server/` 简单 WebSocket 服务器 (Node + ws)

## 快速运行

1. 安装依赖：

   npm install

2. 启动服务器（后端）:

   npm run server

3. 在另一个终端启动前端开发服务器（建议使用 Node >= v20.19.0）：

   npm run dev

> 如果本机使用 Node 版本管理器（例如 nvm/nvm-windows），可切换到 `20.19.0` 或更高并使用 `.nvmrc`：

```bash
nvm install 20.19.0
nvm use 20.19.0
```

4. 打开浏览器访问 `http://localhost:5173`（Vite 默认端口），可在多个窗口中加入相同房间进行对战或观战。

---

一键启动（前后端同时启动）

- 跨平台运行（Windows / macOS / Linux）：

```bash
npm run start
```

该脚本会先启动后端（等待监听 3000），然后自动启动前端开发服务器；控制台将显示带前缀的日志（`[server]` / `[dev]`）。

如果遇到端口被占用或无法连接，请参考前面的“本地联机调试”说明。


注意：若你在 Windows 上遇到 `nodist` 报错（例如“Couldn't decide which node version to use. Please set a version.”），请按下面操作解决：

- 如果已安装 nodist：

```powershell
# 安装并切换到指定版本（若未安装该版本）
nodist add 20.19.0
# 把当前版本切换为 20.19.0
nodist 20.19.0
# 验证
node -v
```

- 若 `nodist` 命令不可用，请先安装 nodist（如用 Chocolatey：`choco install nodist`，或从项目页面下载并安装），然后按上面步骤切换。

- 临时绕过（不改 nodist 设置）：在启动脚本时强制使用系统 Node（PowerShell 示例）：

```powershell
$env:FORCE_NODE = 'C:\Program Files\nodejs\node.exe'
npm run start
```

上面方法会让 `npm run start` 使用指定的 Node 可执行文件而不依赖 nodist。

---

## 本地联机调试（若两个浏览器无法联机）

- 确保后端已启动：在项目根目录运行：

  ```bash
  npm run server
  ```

- 检查前端控制台是否显示 `WS: 已连接`（页面右上控件显示连接状态），两个浏览器都需要显示已连接。
- 如果一方显示未连接：检查是否有防火墙或本地安全软件阻止端口 3000，或尝试改用 `127.0.0.1`：在 `.env` 或启动参数中设置 `VITE_WS_URL=ws://127.0.0.1:3000`。
- 如仍失败，打开服务器终端查看日志（现在服务器会打印连接、加入、断开等事件），以识别连接与加入流程是否正常。
- 注意：若两方都选择“玩家”，服务器会按先后分配 X / O；若玩家位已满，新加入者会被设为观战者（spectator）。
- 若使用不同设备测试，请用机器的局域网 IP（例如 `ws://192.168.1.10:3000`）并允许端口访问。

---

## 新增功能（已实现）
- 昵称支持：在加入房间时可填写昵称，房间中会显示 X / O 玩家昵称。
- 观战统计：在游戏界面显示当前观战人数。
- 重置游戏：玩家可以发起“重置游戏”操作，重置棋盘但保留玩家。
- 更友好的 UI：高亮可落子的子棋盘和可落子格，错误提示显示在界面上。
- 人机对战：加入/创建房间时可选择“对战机器人”来与服务器内置的 AI 对战（简单随机落子，便于本地练习）
- 大厅支持：新增大厅（房间列表），所有用户可在大厅中观战或加入房间；房主/玩家可切换为观战或请求加入战斗（服务器负责分配/替换玩家位）
- 登录：加入游戏前需创建昵称（唯一），昵称在断开连接后会被释放；客户端在登录时会向服务器验证昵称唯一性。
- 修复：防止同一连接被同时分配为 X/O（将自动清理重复分配并在大厅实时更新房间状态），避免出现只有一个玩家能行动的问题。

---

## 注意
- 后端为示例代码，未做持久化或鉴权；仅用于学习与本地演示。
- 代码结构适合扩展：可以进一步加入重连、房间列表、玩家昵称持久化、AI 等功能。

欢迎提出改进需求（例如使用 Socket.IO、加入观战聊天、部署建议等）。